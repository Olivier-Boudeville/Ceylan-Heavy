TOP = ../../..


# This special Makefile is not generated, it has been directly written since
# it is designed to be used by 'autogen.sh'


# For all static settings such as version numbers, mail support, etc. :
SETTINGS_FILE := $(TOP)/src/conf/CeylanSettings.inc
include $(SETTINGS_FILE)


SUBSTITUTE := $(TOP)/src/code/scripts/shell/substitute.sh


.PHONY: all config-files check-configure download-config-scripts \
	get-config-scripts clean clean-download real-clean


CONFIGURE_SOURCE_FILE    = configure-template.ac
CONFIGURE_GENERATED_FILE = $(TOP)/configure.ac


CONFIGURE_SCRIPTS_BASE_URL = \
http://savannah.gnu.org/cgi-bin/viewcvs/*checkout*/config/config
# Was/will be : ftp://ftp.gnu.org/gnu/config

DOWNLOADED_SCRIPTS = config.guess config.sub



all : config-files


config-files: $(CONFIGURE_GENERATED_FILE)

# Uses settings from trunk/src/conf/CeylanSettings.inc to update configure.ac :
$(CONFIGURE_GENERATED_FILE): $(CONFIGURE_SOURCE_FILE) $(SETTINGS_FILE)
	@echo "$(compile_style)    Generating $@$(default_style)"
	@echo "# Do not modify this file !" > $@
	@echo "# '$@' has been generated by filling '$<'" >> $@
	@echo "# with the settings defined in '$(SETTINGS_FILE)' thanks " >> $@
	@echo "# to the 'make -f MakeConfigure' command." >> $@
	@echo "# Hence '$<' and '$(SETTINGS_FILE)' are the" >> $@ 
	@echo "# only sources that should be modified." >> $@
	@echo >> $@
	@cat $< >> $@ 	
	@$(SUBSTITUTE) ST_PROJECT_NAME           $(PROJECT_NAME)          $@
	@$(SUBSTITUTE) ST_UNIX_PROJECT_NAME      $(UNIX_PROJECT_NAME)     $@
	@$(SUBSTITUTE) ST_MAJOR_VERSION          $(CEYLAN_MAJOR_VERSION)  $@
	@$(SUBSTITUTE) ST_MINOR_VERSION          $(CEYLAN_MINOR_VERSION)  $@
	@$(SUBSTITUTE) ST_RELEASE	         $(CEYLAN_RELEASE)        $@
	@$(SUBSTITUTE) ST_DATE_OF_RELEASE        $(CEYLAN_RELEASE_DATE)   $@
	@$(SUBSTITUTE) ST_VERSION                $(CEYLAN_VERSION)        $@
	@$(SUBSTITUTE) ST_FULL_VERSION           $(CEYLAN_FULL_VERSION)   $@
	@$(SUBSTITUTE) ST_MAJOR_ANCESTOR         $(CEYLAN_MAJOR_ANCESTOR) $@
	@$(SUBSTITUTE) ST_OLDEST_SUPPORTED_MAJOR \
		$(CEYLAN_OLDEST_SUPPORTED_MAJOR) $@
	@$(SUBSTITUTE) ST_OLDEST_SUPPORTED_MINOR \
		$(CEYLAN_OLDEST_SUPPORTED_MINOR) $@
	@$(SUBSTITUTE) ST_MAJOR_ANCESTOR         $(CEYLAN_MAJOR_ANCESTOR) $@
	@$(SUBSTITUTE) ST_CONFIG_HEADER          $(CEYLAN_CONFIG_HEADER)  $@
	@$(SUBSTITUTE) ST_MAILING_LIST_SUPPORT \
		$(CEYLAN_MAILING_LIST_SUPPORT) $@
	@$(SUBSTITUTE) ST_MAILING_LIST_BUGTRACKING \
		$(CEYLAN_MAILING_LIST_BUGTRACKING) $@
	
		
check-configure: 
	@$(MAKE) -s $(CONFIGURE_GENERATED_FILE)
	@echo "$(make_style)    Comparing configure files$(default_style)"
	@$(srcdir)/checkConfigure.sh $(DIFF_TOOL)
	@echo "$(command_style)    Comparison finished,\
	$(CONFIGURE_SOURCE_FILE) may be updated now."


get-config-scripts: download-config-scripts
	@echo "$(make_style)    Patching config.sub \
	for the Nintendo DS$(default_style)"
	@patch config.sub patch-for-config.sub 1>/dev/null


download-config-scripts: clean-download
	@echo "$(make_style)    Downloading latest configure helper\
	scripts$(default_style)"
	@for f in $(DOWNLOADED_SCRIPTS); do \
	wget --quiet $(CONFIGURE_SCRIPTS_BASE_URL)/$$f ; done
	@chmod +x $(DOWNLOADED_SCRIPTS)

	
clean:
	@echo "$(clean_style)    Cleaning generated config-related\
	files$(default_style)"
	-@rm -f autoscan*.log autoscan.err configure-from-autoscan.ac\
	configure-from-autoupdate.ac $(CONFIGURE_GENERATED_FILE)\
	$(TOP)/$(CONFIGURE_GENERATED_FILE) ltmain.sh missing install-sh\
	m4/aclocal.m4 $(TOP)/aclocal.m4 $(TOP)/configure $(TOP)/config.log\
	$(TOP)/configure.scan $(TOP)/config.status $(TOP)/Makefile\
	$(TOP)/Makefile.in $(TOP)/libtool $(TOP)/auto*.log 
	-@rm -rf autom4te.cache $(TOP)/autom4te.cache
	
	
clean-download:
	@echo "$(clean_style)    Cleaning downloaded config\
	files$(default_style)"
	-@rm -f $(DOWNLOADED_SCRIPTS)
	
	
real-clean: clean clean-download
